<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pomodoro</title>

<!--
  Pomodoro – v1.0.0
  Fecha: 2025-08-25
  Notas:
  - PWA (manifest + service worker)
  - Estadísticas y gamificación (XP, niveles, logros, racha, actividad 7 días)
  - Modo enfoque minimalista durante el conteo
  - Ajustes con persistencia y color de acento global
  Versionado: SemVer (MAJOR.MINOR.PATCH)
  Claves de almacenamiento: pomodoro:options, pomodoro:stats, pomodoro:version
-->

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7c3aed">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root {
    --bg: #0f1115;
    --panel: #151a24;
    --muted: #8b93a7;
    --text: #e6e9ef;
    --accent: #7c3aed; /* editable en Ajustes */
    --accent-700: #5e2bb4; /* recalculado por JS */
    --accentA15: rgba(124,58,237,0.15);
    --accentA35: rgba(124,58,237,0.35);
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: radial-gradient(1200px 800px at 50% -20%, #1a1f2a 0%, #0f1115 60%); color: var(--text); display: grid; place-items: center; }

  .app { width: min(820px, 92vw); transition: filter .35s ease, opacity .35s ease; }
  header { text-align: center; margin-bottom: 1.25rem; }
  h1 { margin: .4rem 0 0; font-weight: 800; font-size: clamp(20px, 2.8vw, 28px); letter-spacing: .4px; color: var(--accent); }
  .subtitle { color: var(--muted); font-size: 12px; letter-spacing: .2px; }

  .card { background: linear-gradient(180deg, #181c25 0%, #121620 100%); border: 1px solid #222736; border-radius: 20px; box-shadow: var(--shadow); padding: 20px; position: relative; }

  /* Tabs */
  .tabs { display: grid; grid-auto-flow: column; gap: 8px; background: #0f1320; border-radius: 14px; padding: 6px; border: 1px solid #1f2433; }
  .tab { border: none; background: transparent; color: var(--muted); padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 700; letter-spacing: .3px; transition: color .2s ease, background .2s ease, transform .1s ease; }
  .tab:focus-visible, .control:focus-visible, .toggle:focus-visible, input:focus-visible, select:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 10px; }
  .tab.active { background: var(--accentA15); color: var(--accent); box-shadow: inset 0 0 0 1px var(--accentA35); }
  .tab:hover { transform: translateY(-1px); }

  /* Timer */
  .timer { text-align: center; padding: 26px 10px 10px; }
  .time { font-variant-numeric: tabular-nums; font-size: clamp(64px, 13vw, 140px); font-weight: 900; letter-spacing: 2px; line-height: 1; display: inline-block; transition: transform .12s ease; }
  .time.tick { transform: scale(1.02); }
  .status { height: 22px; margin-top: 10px; color: var(--muted); font-size: 13px; letter-spacing: .3px; text-transform: uppercase; text-align: center; opacity: .85; transition: opacity .3s ease; }
  .status.fade { opacity: 0; }

  /* Controls */
  .controls { display: grid; grid-auto-flow: column; gap: 10px; justify-content: center; margin: 18px 0 6px; }
  .control { --bg: var(--accent); border: none; cursor: pointer; padding: 12px 16px; border-radius: 14px; font-weight: 800; letter-spacing: .3px; color: white; background: linear-gradient(180deg, var(--bg), var(--accent-700)); box-shadow: 0 6px 18px rgba(124,58,237,0.25), inset 0 0 0 1px rgba(255,255,255,0.12); transition: filter .2s ease, transform .06s ease, background .2s ease; }
  .control.secondary { color: var(--text); background: #1a2030; box-shadow: inset 0 0 0 1px #283046; }
  .control:hover { filter: brightness(1.05); }
  .control:active { transform: translateY(1px); }

  /* Settings + Stats toggles */
  .bar-head { display: flex; gap: 8px; align-items: center; justify-content: space-between; margin-top: 6px; flex-wrap: wrap; }
  .toggles { display: flex; gap: 8px; }
  .toggle { background: #0f1320; color: var(--text); border: 1px solid #1f2433; border-radius: 12px; padding: 8px 12px; cursor: pointer; display: inline-flex; gap: 8px; align-items: center; }
  .gear, .chart { font-size: 18px; }
  .panel { max-height: 0; overflow: hidden; transition: max-height .35s ease; }
  .panel.open { max-height: 1200px; }

  /* Settings panel layout */
  .grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 14px; margin-top: 14px; }
  .row { background: #0f1320; border: 1px solid #1f2433; border-radius: 14px; padding: 12px; }
  .row label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 8px; letter-spacing: .3px; }
  .row input[type="number"], .row select, .row input[type="color"] { width: 100%; background: #12172a; color: var(--text); border: 1px solid #232a44; border-radius: 10px; padding: 10px; font-weight: 700; }
  .row input[type="checkbox"] { transform: translateY(2px); }
  .row .check { display: flex; gap: 10px; align-items: center; font-weight: 700; }

  footer { text-align: center; color: var(--muted); font-size: 12px; margin-top: 12px; }

  /* Focus (modo minimalista mientras corre) */
  body.focus header, body.focus .tabs, body.focus .status, body.focus .bar-head, body.focus #settings, body.focus #statsPanel, body.focus footer { display: none !important; }
  body.focus .app { width: min(640px, 92vw); }
  body.focus .card { background: #0e131d; border-color: #171c28; box-shadow: none; filter: brightness(.8) contrast(.9) saturate(.9); }
  body.focus .control { box-shadow: none; }

  /* Stats panel */
  .stats-grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; margin-top: 14px; }
  .stat { background:#0f1320; border:1px solid #1f2433; border-radius:14px; padding:12px; }
  .stat .label { color: var(--muted); font-size: 12px; letter-spacing: .3px; }
  .stat .value { font-size: 24px; font-weight: 800; margin-top: 6px; }

  .level { background:#0f1320; border:1px solid #1f2433; border-radius:14px; padding:12px; margin-top:12px; }
  .level-head { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .xpbar { height: 10px; background:#0c1020; border:1px solid #1b2132; border-radius:999px; overflow:hidden; margin-top:8px; }
  .xpbar > div { height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-700)); transition: width .4s ease; }

  .sparks { display:grid; grid-auto-flow:column; gap:6px; align-items:end; height:64px; margin-top:8px; }
  .sparks .bar { width: 20px; background: var(--accentA15); border:1px solid var(--accentA35); border-radius:8px 8px 4px 4px; position: relative; }
  .sparks .bar::after { content: attr(data-day); position:absolute; bottom:-18px; left:50%; transform:translateX(-50%); font-size:10px; color:var(--muted); }

  .badges { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
  .badge { border:1px solid #24304a; background:#0f1320; color:var(--muted); padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; opacity:.6; }
  .badge.unlocked { color: var(--text); border-color: var(--accentA35); background: var(--accentA15); opacity:1; }

  .toasts { position: fixed; left:50%; bottom: 20px; transform: translateX(-50%); display: grid; gap: 8px; z-index: 999; }
  .toast { background:#0f1320; border:1px solid #24304a; border-radius:12px; padding:10px 14px; box-shadow: var(--shadow); font-weight:700; }

  @media (max-width: 720px) { .stats-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width: 520px) { .grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="subtitle">Productividad sin distracciones</div>
      <h1>Pomodoro</h1>
    </header>

    <section class="card" aria-label="Temporizador Pomodoro">
      <div class="tabs" role="tablist">
        <button class="tab active" role="tab" aria-selected="true" data-mode="pomodoro">Pomodoro</button>
        <button class="tab" role="tab" data-mode="short">Descanso corto</button>
        <button class="tab" role="tab" data-mode="long">Descanso largo</button>
      </div>

      <div class="timer">
        <div class="time" id="time" aria-live="polite">25:00</div>
        <div class="status" id="status">Listo</div>
        <div class="controls" aria-label="Controles">
          <button class="control" id="startPause">Iniciar</button>
          <button class="control secondary" id="reset">Reiniciar</button>
          <button class="control secondary" id="skip">Saltar</button>
        </div>
      </div>

      <div class="bar-head">
        <div class="toggles">
          <button class="toggle" id="toggleSettings" aria-expanded="false" aria-controls="settings"><span class="gear">⚙︎</span><span>Ajustes</span></button>
          <button class="toggle" id="toggleStats" aria-expanded="false" aria-controls="statsPanel"><span class="chart">📈</span><span>Estadísticas</span></button>
        </div>
        <small class="subtitle">Atajos: <b>Espacio</b> Iniciar/Pausar · <b>R</b> Reiniciar · <b>M</b> Cambiar modo</small>
      </div>

      <!-- Ajustes -->
      <div class="panel" id="settings">
        <div class="grid">
          <div class="row"><label>Duración Pomodoro (min)</label><input id="durPomodoro" type="number" min="1" max="180" step="1" /></div>
          <div class="row"><label>Duración descanso corto (min)</label><input id="durShort" type="number" min="1" max="60" step="1" /></div>
          <div class="row"><label>Duración descanso largo (min)</label><input id="durLong" type="number" min="1" max="120" step="1" /></div>
          <div class="row"><label>Frecuencia de descanso largo (cada N pomodoros)</label><input id="longEvery" type="number" min="1" max="12" step="1" /></div>
          <div class="row">
            <label>Auto-inicio</label>
            <div class="check"><input id="autoStartWork" type="checkbox" /> <span>Iniciar automáticamente Pomodoros</span></div>
            <div class="check" style="margin-top:8px"><input id="autoStartBreaks" type="checkbox" /> <span>Iniciar automáticamente descansos</span></div>
          </div>
          <div class="row">
            <label>Notificaciones & sonido</label>
            <div class="check"><input id="enableNotify" type="checkbox" /> <span>Notificaciones nativas del navegador</span></div>
            <div class="check" style="margin-top:8px"><input id="enableSound" type="checkbox" /> <span>Sonido al terminar la fase</span></div>
          </div>
          <div class="row"><label>Color de acento</label><input id="accent" type="color" /></div>
          <div class="row" style="display:flex;align-items:end;justify-content:space-between;gap:10px">
            <div><label>Vista previa</label><div style="height:40px; width:120px; border-radius:10px; background:linear-gradient(90deg,var(--accent),var(--accent-700)); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12);"></div></div>
            <button class="control" id="save">Guardar ajustes</button>
          </div>
        </div>
      </div>

      <!-- Estadísticas -->
      <div class="panel" id="statsPanel">
        <div class="stats-grid">
          <div class="stat"><div class="label">Hoy</div><div class="value" id="stToday">0</div></div>
          <div class="stat"><div class="label">Esta semana</div><div class="value" id="stWeek">0</div></div>
          <div class="stat"><div class="label">Total</div><div class="value" id="stTotal">0</div></div>
          <div class="stat"><div class="label">Racha (días)</div><div class="value" id="stStreak">0</div></div>
        </div>

        <div class="level">
          <div class="level-head">
            <div><strong id="lvlLabel">Nivel 1</strong> · <span id="xpLabel">0 XP</span></div>
            <div id="nextLabel" class="subtitle">0 / 50 para el siguiente</div>
          </div>
          <div class="xpbar"><div id="xpFill" style="width:0%"></div></div>
        </div>

        <div class="row" style="margin-top:12px;">
          <label>Actividad (últimos 7 días)</label>
          <div class="sparks" id="sparks"></div>
        </div>

        <div class="row" style="margin-top:12px;">
          <label>Logros</label>
          <div class="badges" id="badges"></div>
        </div>
      </div>

    </section>

    <footer>Hecho con <span style="color:var(--accent)">•</span> para concentrarte.</footer>
  </div>

  <div class="toasts" id="toasts" aria-live="polite"></div>

<script>
(function(){
  const APP_VERSION = '1.0.0';
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  const elTime = $('#time');
  const elStatus = $('#status');
  const elStartPause = $('#startPause');
  const elReset = $('#reset');
  const elSkip = $('#skip');
  const tabs = $$('.tab');
  const settings = $('#settings');
  const statsPanel = $('#statsPanel');
  const toggleSettings = $('#toggleSettings');
  const toggleStats = $('#toggleStats');
  const toasts = $('#toasts');

  // Settings inputs
  const inputPom = $('#durPomodoro');
  const inputShort = $('#durShort');
  const inputLong = $('#durLong');
  const inputLongEvery = $('#longEvery');
  const chkAutoWork = $('#autoStartWork');
  const chkAutoBreaks = $('#autoStartBreaks');
  const chkNotify = $('#enableNotify');
  const chkSound = $('#enableSound');
  const inputAccent = $('#accent');
  const btnSave = $('#save');

  // Stats UI
  const stToday = $('#stToday');
  const stWeek = $('#stWeek');
  const stTotal = $('#stTotal');
  const stStreak = $('#stStreak');
  const sparks = $('#sparks');
  const badges = $('#badges');
  const lvlLabel = $('#lvlLabel');
  const xpLabel = $('#xpLabel');
  const nextLabel = $('#nextLabel');
  const xpFill = $('#xpFill');

  const DEFAULTS = {
    pomodoro: 25, short: 5, long: 15, longEvery: 4,
    autoStartWork: false, autoStartBreaks: false,
    notifications: false, sound: true,
    accent: getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#7c3aed'
  };

  const STATS_DEFAULT = { days: {}, total: 0, streak: 0, lastDay: null, xp: 0, achievements: {} };

  // ===== Version/migrations scaffold =====
  (function versionInit(){
    const stored = localStorage.getItem('pomodoro:version');
    if (!stored) {
      localStorage.setItem('pomodoro:version', APP_VERSION);
      return;
    }
    if (stored !== APP_VERSION) {
      try { migrate(stored, APP_VERSION); } catch(e) {}
      localStorage.setItem('pomodoro:version', APP_VERSION);
    }
  })();

  function migrate(fromV, toV){
    // Punto para futuras migraciones si cambiamos estructura de stats/options
    // if (fromV === '1.0.0' && toV === '1.1.0') { ... }
  }

  let options = loadOptions();
  let stats = loadStats();
  applyOptionsToUI();
  applyAccent(options.accent);

  let state = { mode: 'pomodoro', isRunning: false, remaining: options.pomodoro * 60, intervalId: null, completedPomodoros: 0 };

  updateTimeText();
  updateStatus('Listo');
  updateTitle();
  renderStatsUI();

  /* Tabs */
  tabs.forEach(btn => btn.addEventListener('click', () => { switchMode(btn.dataset.mode, true); }));

  /* Controls */
  elStartPause.addEventListener('click', () => state.isRunning ? pauseTimer() : startTimer());
  elReset.addEventListener('click', resetTimer);
  elSkip.addEventListener('click', endPhaseAndAdvance);

  /* Toggles */
  toggleSettings.addEventListener('click', () => togglePanel(settings, toggleSettings));
  toggleStats.addEventListener('click', () => togglePanel(statsPanel, toggleStats));
  function togglePanel(panel, btn){ const open = panel.classList.toggle('open'); btn.setAttribute('aria-expanded', open ? 'true' : 'false'); }

  /* Save settings */
  btnSave.addEventListener('click', () => {
    options = {
      pomodoro: clampInt(inputPom.value, 1, 180, DEFAULTS.pomodoro),
      short: clampInt(inputShort.value, 1, 60, DEFAULTS.short),
      long: clampInt(inputLong.value, 1, 120, DEFAULTS.long),
      longEvery: clampInt(inputLongEvery.value, 1, 12, DEFAULTS.longEvery),
      autoStartWork: !!chkAutoWork.checked, autoStartBreaks: !!chkAutoBreaks.checked,
      notifications: !!chkNotify.checked, sound: !!chkSound.checked, accent: inputAccent.value || DEFAULTS.accent
    };
    if (options.notifications && 'Notification' in window) { if (Notification.permission === 'default') { Notification.requestPermission(); } }
    saveOptions(options); applyAccent(options.accent); state.remaining = getCurrentModeMinutes() * 60; updateTimeText(); announce('Ajustes guardados');
  });

  /* Keyboard shortcuts */
  window.addEventListener('keydown', (e) => {
    const tag = (e.target && e.target.tagName) || ''; const typing = ['INPUT','TEXTAREA'].includes(tag);
    if (e.code === 'Space' && !typing) { e.preventDefault(); state.isRunning ? pauseTimer() : startTimer(); }
    else if ((e.key === 'r' || e.key === 'R') && !typing) { e.preventDefault(); resetTimer(); }
    else if ((e.key === 'm' || e.key === 'M') && !typing) { e.preventDefault(); cycleMode(); }
  });

  function cycleMode(){ const order = ['pomodoro','short','long']; const i = order.indexOf(state.mode); const next = order[(i+1)%order.length]; switchMode(next, true); }

  function switchMode(mode, userInitiated=false){ if (!['pomodoro','short','long'].includes(mode)) return; state.mode = mode; state.isRunning = false; clearInterval(state.intervalId); state.intervalId = null; state.remaining = getCurrentModeMinutes() * 60; elStartPause.textContent = 'Iniciar'; tabs.forEach(t=>{ t.classList.toggle('active', t.dataset.mode===mode); t.setAttribute('aria-selected', t.dataset.mode===mode ? 'true' : 'false'); }); updateTimeText(); updateStatus(userInitiated ? `Modo: ${labelFor(mode)}` : statusFor(mode)); updateTitle(); document.body.classList.remove('focus'); }

  function startTimer(){ if (state.isRunning) return; const now = Date.now(); let end = now + state.remaining*1000 + 50; state.isRunning = true; document.body.classList.add('focus'); elStartPause.textContent = 'Pausar'; updateStatus('En curso'); state.intervalId = setInterval(()=>{ const t = end - Date.now(); state.remaining = Math.max(0, Math.round(t/1000)); updateTimeText(); updateTitle(); if (state.remaining <= 0){ clearInterval(state.intervalId); state.intervalId = null; state.isRunning = false; endPhaseAndAdvance(); } }, 250); }

  function pauseTimer(){ if (!state.isRunning) return; state.isRunning = false; clearInterval(state.intervalId); state.intervalId = null; document.body.classList.remove('focus'); elStartPause.textContent = 'Iniciar'; updateStatus('Pausado'); updateTitle(); }

  function resetTimer(){ clearInterval(state.intervalId); state.intervalId = null; state.isRunning = false; document.body.classList.remove('focus'); state.remaining = getCurrentModeMinutes()*60; updateTimeText(); elStartPause.textContent = 'Iniciar'; updateStatus('Listo'); updateTitle(); }

  function endPhaseAndAdvance(){
    if (options.sound) beep(); notify(`${labelFor(state.mode)} terminado`, nextPhaseMessage());

    if (state.mode === 'pomodoro') { state.completedPomodoros++; recordPomodoro(); }

    let nextMode; if (state.mode === 'pomodoro'){ const isLong = state.completedPomodoros % options.longEvery === 0; nextMode = isLong ? 'long' : 'short'; switchMode(nextMode); if (options.autoStartBreaks) { startTimer(); } else { document.body.classList.remove('focus'); } } else { nextMode = 'pomodoro'; switchMode(nextMode); if (options.autoStartWork) { startTimer(); } else { document.body.classList.remove('focus'); } }
  }

  function nextPhaseMessage(){ if (state.mode === 'pomodoro'){ const isLong = state.completedPomodoros % options.longEvery === 0; return `Empieza ${(isLong?'descanso largo':'descanso corto')}.`; } else { return 'Vuelve a un Pomodoro.'; } }

  function updateTimeText(){ const mm = Math.floor(state.remaining/60); const ss = state.remaining % 60; const txt = `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; if (elTime.textContent !== txt){ elTime.textContent = txt; elTime.classList.remove('tick'); void elTime.offsetWidth; elTime.classList.add('tick'); } }

  function updateStatus(text){ elStatus.classList.add('fade'); setTimeout(()=>{ elStatus.textContent = text; elStatus.classList.remove('fade'); }, 120); }

  function statusFor(mode){ return ({ pomodoro: 'Enfócate', short: 'Respira: descanso corto', long: 'Tómate tu tiempo: descanso largo' })[mode]; }
  function labelFor(mode){ return ({ pomodoro: 'Pomodoro', short: 'Descanso corto', long: 'Descanso largo' })[mode]; }
  function getCurrentModeMinutes(){ return ({ pomodoro: options.pomodoro, short: options.short, long: options.long })[state.mode]; }

  function updateTitle(){ const mm = Math.floor(state.remaining/60).toString().padStart(2,'0'); const ss = (state.remaining%60).toString().padStart(2,'0'); document.title = `${mm}:${ss} • ${labelFor(state.mode)}${state.isRunning?' ⏱️':''}`; }

  function clampInt(v, min, max, fallback){ v = parseInt(v, 10); if (Number.isNaN(v)) return fallback; return Math.max(min, Math.min(max, v)); }

  function saveOptions(opts){ localStorage.setItem('pomodoro:options', JSON.stringify(opts)); }
  function loadOptions(){ try { return Object.assign({}, DEFAULTS, JSON.parse(localStorage.getItem('pomodoro:options')||'{}')); } catch(e){ return {...DEFAULTS}; } }

  function applyOptionsToUI(){ inputPom.value = options.pomodoro; inputShort.value = options.short; inputLong.value = options.long; inputLongEvery.value = options.longEvery; chkAutoWork.checked = options.autoStartWork; chkAutoBreaks.checked = options.autoStartBreaks; chkNotify.checked = options.notifications; chkSound.checked = options.sound; inputAccent.value = options.accent; }

  function applyAccent(color){ const root = document.documentElement.style; root.setProperty('--accent', color); root.setProperty('--accent-700', shade(color, -12)); root.setProperty('--accentA15', hexToRgba(color, 0.15)); root.setProperty('--accentA35', hexToRgba(color, 0.35)); }
  function shade(hex, percent){ if (!/^#([\da-fA-F]{6})$/.test(hex)) return hex; const r = parseInt(hex.slice(1,3),16); const g = parseInt(hex.slice(3,5),16); const b = parseInt(hex.slice(5,7),16); const f = (x)=> Math.round(Math.max(0, Math.min(255, x + 255*percent/100))); const out = (n)=> n.toString(16).padStart(2,'0'); return `#${out(f(r))}${out(f(g))}${out(f(b))}`; }
  function hexToRgba(hex, a){ if (!/^#([\da-fA-F]{6})$/.test(hex)) return `rgba(124,58,237,${a})`; const r = parseInt(hex.slice(1,3),16); const g = parseInt(hex.slice(3,5),16); const b = parseInt(hex.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; }

  function announce(msg){ updateStatus(msg); }

  /* Notificaciones */
  function notify(title, body){ if (!options.notifications || !('Notification' in window)) return; if (Notification.permission === 'granted') { new Notification(title, { body }); } else if (Notification.permission === 'default') { Notification.requestPermission().then(p=>{ if (p==='granted') new Notification(title, { body }); }); } }

  /* Sonido: WebAudio (compatibilidad iPad) */
  function beep(){ try { const Ctx = window.AudioContext || window.webkitAudioContext; if (!Ctx) return; const ctx = new Ctx(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type = 'sine'; o.frequency.setValueAtTime(880, ctx.currentTime); g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime + 0.02); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35); o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime + 0.4); setTimeout(()=>{ const o2 = ctx.createOscillator(); const g2 = ctx.createGain(); o2.type = 'triangle'; o2.frequency.setValueAtTime(660, ctx.currentTime); g2.gain.setValueAtTime(0.0001, ctx.currentTime); g2.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime + 0.02); g2.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.32); o2.connect(g2).connect(ctx.destination); o2.start(); o2.stop(ctx.currentTime + 0.35); }, 120); } catch (e) { /* ignore */ } }

  /* =========================
     ====== ESTADÍSTICAS =====
     ========================= */
  function loadStats(){ try { return Object.assign({}, STATS_DEFAULT, JSON.parse(localStorage.getItem('pomodoro:stats')||'{}')); } catch(e){ return {...STATS_DEFAULT}; } }
  function saveStats(){ localStorage.setItem('pomodoro:stats', JSON.stringify(stats)); }
  function todayKey(){ const d = new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function dayKey(date){ const d = new Date(date); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function yesterdayKey(){ const d=new Date(); d.setDate(d.getDate()-1); return dayKey(d); }

  function recordPomodoro(){
    const key = todayKey();
    stats.days[key] = (stats.days[key]||0) + 1;
    stats.total += 1;
    // Streak
    if (!stats.lastDay) { stats.streak = 1; }
    else if (stats.lastDay === key) { /* same day, streak unchanged */ }
    else if (stats.lastDay === yesterdayKey()) { stats.streak += 1; }
    else { stats.streak = 1; }
    stats.lastDay = key;
    // XP
    stats.xp += 10; // 10 XP por pomodoro
    // Achievements & level ups
    const unlocked = checkAchievements();
    const levelInfo = getLevel(stats.xp);
    if (unlocked.length) { unlocked.forEach(a=>toast(`🏅 Logro desbloqueado: ${a}`)); }
    if (levelInfo.justLeveled) { toast(`⬆️ ¡Nivel ${levelInfo.level}!`); }

    saveStats();
    renderStatsUI();
  }

  function getLast7(){ const out=[]; const now = new Date(); for (let i=6;i>=0;i--){ const d=new Date(now); d.setDate(now.getDate()-i); const key=dayKey(d); out.push({ key, count: stats.days[key]||0, short: ['D','L','M','X','J','V','S'][d.getDay()] }); } return out; }
  function sumWeek(){ return getLast7().reduce((a,b)=>a+b.count,0); }

  function getLevel(xp){
    // Sistema de niveles con coste creciente ~25% por nivel
    let lvl = 1; let need = 50; let remainingXp = xp; let justLeveled=false;
    while (remainingXp >= need) { remainingXp -= need; lvl++; need = Math.round(need * 1.25); justLeveled = true; }
    const progress = Math.max(0, Math.min(1, remainingXp / need));
    return { level: lvl, progress, need, have: remainingXp, toNext: need - remainingXp, justLeveled };
  }

  function achievementsCatalog(){
    return [
      { id:'first', label:'Primer Pomodoro', test: s=>s.total>=1 },
      { id:'p5', label:'5 Pomodoros', test: s=>s.total>=5 },
      { id:'p25', label:'25 Pomodoros', test: s=>s.total>=25 },
      { id:'p100', label:'100 Pomodoros', test: s=>s.total>=100 },
      { id:'streak3', label:'Racha de 3 días', test: s=>s.streak>=3 },
      { id:'streak7', label:'Racha de 7 días', test: s=>s.streak>=7 },
      { id:'day4', label:'4 en un día', test: s=> (s.days[todayKey()]||0) >=4 },
      { id:'day8', label:'8 en un día', test: s=> (s.days[todayKey()]||0) >=8 },
    ];
  }

  function checkAchievements(){
    const cat = achievementsCatalog(); const unlocked=[];
    cat.forEach(a=>{ if (!stats.achievements[a.id] && a.test(stats)) { stats.achievements[a.id]=true; unlocked.push(a.label); } });
    return unlocked;
  }

  function renderStatsUI(){
    stToday.textContent = (stats.days[todayKey()]||0);
    stWeek.textContent = sumWeek();
    stTotal.textContent = stats.total;
    stStreak.textContent = stats.streak;

    // Nivel
    const li = getLevel(stats.xp);
    lvlLabel.textContent = `Nivel ${li.level}`;
    xpLabel.textContent = `${stats.xp} XP`;
    nextLabel.textContent = `${li.have} / ${li.need} para el siguiente`;
    xpFill.style.width = (li.progress*100).toFixed(0)+"%";

    // Sparks (7 días)
    const last7 = getLast7(); const max = Math.max(1, ...last7.map(d=>d.count));
    sparks.innerHTML = '';
    last7.forEach(d=>{
      const bar = document.createElement('div');
      bar.className = 'bar';
      const h = Math.max(8, Math.round(56 * (d.count/max)) );
      bar.style.height = h + 'px';
      bar.setAttribute('data-day', d.short);
      bar.title = `${d.key}: ${d.count}`;
      sparks.appendChild(bar);
    });

    // Badges
    badges.innerHTML='';
    const cat = achievementsCatalog();
    cat.forEach(a=>{
      const b = document.createElement('div'); b.className = 'badge' + (stats.achievements[a.id]?' unlocked':''); b.textContent = a.label; badges.appendChild(b);
    });
  }

  function toast(msg){ const t = document.createElement('div'); t.className='toast'; t.textContent=msg; toasts.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s ease'; setTimeout(()=>t.remove(), 320); }, 2400); }

  /* ===== Service Worker (PWA) ===== */
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{/* Silenciar si no está subido todavía */});
    });
  }

})();
</script>
</body>
</html>
